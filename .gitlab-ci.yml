# GitLab CI/CD Pipeline for CDK Cost Analyzer
# This pipeline handles testing, building, and publishing the package

stages:
  - test
  # - build  # Temporarily disabled due to build issues
  - release

variables:
  NODE_VERSION: "18"
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"

# Cache configuration for faster builds
.node_cache: &node_cache
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - node_modules/
      - .yarn/
      - .npm/

# Test stage - Run on all commits
test:
  stage: test
  image: node:${NODE_VERSION}
  <<: *node_cache
  before_script:
    - npm install -g projen
    - npx projen install:ci
  script:
    # Run linting
    - npx projen lint
    # Run tests
    - npx projen test
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_TAG'

# Build stage - Create package (TEMPORARILY DISABLED)
# build:
#   stage: build
#   image: node:${NODE_VERSION}
#   <<: *node_cache
#   before_script:
#     - npm install -g projen
#     - npx projen install:ci
#   script:
#     # Run full build (includes compile, test, package)
#     - npx projen build
#   artifacts:
#     paths:
#       - dist/
#       - dist/js/*.tgz
#     expire_in: 1 week
#   rules:
#     - if: '$CI_COMMIT_TAG'
#     - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

# Publish to NPM - Manual trigger for tags (DISABLED - depends on build)
# publish:npm:
#   stage: release
#   image: node:${NODE_VERSION}
#   dependencies:
#     - build
#   before_script:
#     - npm install -g projen
#   script:
#     # Configure NPM authentication
#     - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
#     # Publish to NPM
#     - npm publish --access public
#   after_script:
#     # Clean up credentials
#     - rm -f .npmrc
#   rules:
#     - if: '$CI_COMMIT_TAG && $NPM_TOKEN'
#       when: manual
#   environment:
#     name: npm-registry
#     url: https://www.npmjs.com/package/cdk-cost-analyzer

# Publish to GitLab Package Registry - Automatic for tags (DISABLED - depends on build)
# publish:gitlab:
#   stage: release
#   image: node:${NODE_VERSION}
#   dependencies:
#     - build
#   before_script:
#     - npm install -g projen
#   script:
#     # Configure GitLab Package Registry authentication
#     - echo "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" > .npmrc
#     - echo "@${CI_PROJECT_ROOT_NAMESPACE}:registry=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/npm/" >> .npmrc
#     # Publish to GitLab Package Registry
#     - npm publish
#   after_script:
#     # Clean up credentials
#     - rm -f .npmrc
#   rules:
#     - if: '$CI_COMMIT_TAG'
#   environment:
#     name: gitlab-package-registry
#     url: ${CI_PROJECT_URL}/-/packages

# Create GitLab Release with release notes (DISABLED - depends on build)
# release:
#   stage: release
#   image: registry.gitlab.com/gitlab-org/release-cli:latest
#   dependencies:
#     - build
#   script:
#     - echo "Creating release for ${CI_COMMIT_TAG}"
#   release:
#     tag_name: '${CI_COMMIT_TAG}'
#     description: |
#       ## Release ${CI_COMMIT_TAG}
#       
#       ### Installation
#       
#       ```bash
#       npm install -g cdk-cost-analyzer@${CI_COMMIT_TAG}
#       ```
#       
#       ### Changes
#       
#       See [CHANGELOG.md](${CI_PROJECT_URL}/-/blob/${CI_COMMIT_TAG}/CHANGELOG.md) for details.
#       
#       ### Package
#       
#       - [NPM Package](https://www.npmjs.com/package/cdk-cost-analyzer/v/${CI_COMMIT_TAG})
#       - [GitLab Package](${CI_PROJECT_URL}/-/packages)
#     assets:
#       links:
#         - name: 'NPM Package'
#           url: 'https://www.npmjs.com/package/cdk-cost-analyzer'
#           link_type: 'package'
#   rules:
#     - if: '$CI_COMMIT_TAG'

# Quality gates - Run on merge requests
quality-gates:
  stage: test
  image: node:${NODE_VERSION}
  <<: *node_cache
  before_script:
    - npm install -g projen
    - npx projen install:ci
  script:
    # Check TypeScript compilation
    - npx projen compile
    # Run linting
    - npx projen lint
    # Run tests with coverage
    - npx projen test
    # Verify coverage threshold (80%)
    - |
      if [ -f coverage/coverage-summary.json ]; then
        COVERAGE=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.lines.pct")
        echo "Code coverage: ${COVERAGE}%"
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          echo "ERROR: Code coverage ${COVERAGE}% is below threshold of 80%"
          exit 1
        fi
      fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  allow_failure: false

# Dependency security scanning
dependency-scanning:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - npm audit --audit-level=moderate
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  allow_failure: true

# Version bump helper - Manual trigger to create version bump commit (DISABLED - depends on build)
# bump-version:
#   stage: build
#   image: node:${NODE_VERSION}
#   <<: *node_cache
#   before_script:
#     - npm install -g projen
#     - npx projen install:ci
#     # Configure git
#     - git config user.email "ci@gitlab.com"
#     - git config user.name "GitLab CI"
#   script:
#     # Run projen bump to create version bump
#     - npx projen bump
#     # Push the version bump commit and tag
#     - git push origin HEAD:${CI_COMMIT_BRANCH}
#     - git push --tags
#   rules:
#     - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
#       when: manual
#   only:
#     - main
#     - master
