---
title: Fix Pricing Calculator Detection Issues
status: draft
created: 2026-01-19
---

# Fix Pricing Calculator Detection Issues

## Problem Statement

The cdk-cost-analyzer tool fails to detect and calculate costs for most AWS resources, showing $0.00 for resources that have working calculators. Testing with a real-world CDK stack reveals that only Lambda functions are properly priced, while NAT Gateways, Application Load Balancers, ECS Fargate services, DynamoDB tables, and AutoScaling Groups all show $0.00.

## Current Behavior

When analyzing a CloudFormation template containing:
- AWS::EC2::NatGateway
- AWS::ElasticLoadBalancingV2::LoadBalancer
- AWS::ECS::Service (Fargate)
- AWS::DynamoDB::Table
- AWS::AutoScaling::AutoScalingGroup
- AWS::Lambda::Function

Only the Lambda function returns a cost estimate ($2.08/month). All other resources show `$0.00 [unknown]`.

## Root Cause Analysis

1. **Pricing API queries work** - Manual testing confirms AWS Pricing API returns correct data
2. **Calculators exist** - Code inspection shows calculators for all major resource types
3. **Query generation fails** - The pricing queries generated by calculators don't match AWS Pricing API format

### Verified Issues

#### NAT Gateway Calculator
- Calculator exists at `src/pricing/calculators/NatGatewayCalculator.ts`
- Supports resource type `AWS::EC2::NatGateway`
- Pricing API query likely fails due to filter mismatch

#### ALB Calculator
- Calculator exists at `src/pricing/calculators/ALBCalculator.ts`
- Supports resource type `AWS::ElasticLoadBalancingV2::LoadBalancer`
- Needs to distinguish between ALB and NLB

#### ECS Calculator
- Calculator exists at `src/pricing/calculators/ECSCalculator.ts`
- Supports resource type `AWS::ECS::Service`
- Must extract Fargate CPU/memory from task definition

#### DynamoDB Calculator
- Calculator exists at `src/pricing/calculators/DynamoDBCalculator.ts`
- Supports resource type `AWS::DynamoDB::Table`
- Pay-per-request pricing requires usage assumptions

#### AutoScaling Group Support
- No calculator for `AWS::AutoScaling::AutoScalingGroup`
- No calculator for `AWS::AutoScaling::LaunchConfiguration`
- EC2Calculator exists but doesn't support ASG resources

## Expected Behavior

For the test stack, the analyzer should report:
- NAT Gateway: ~$33/month (hourly + data processing)
- Application Load Balancer: ~$16/month (hourly + LCU charges)
- ECS Fargate (2 tasks, 0.25 vCPU, 0.5 GB): ~$15-20/month
- DynamoDB (pay-per-request): $0.00 with usage assumptions note
- Lambda: $2.08/month (currently working)
- AutoScaling Group (2 x t3.micro): ~$17.52/month

**Total expected: ~$83-103/month**

## Proposed Solution

### Phase 1: Diagnostic Improvements

1. **Add debug logging**
   - Log pricing API queries before execution
   - Log pricing API responses
   - Log filter values used in queries
   - Add `--debug` flag to CLI

2. **Improve error messages**
   - Show which filters failed to match
   - Suggest correct filter values
   - Display pricing API error responses

### Phase 2: Fix Existing Calculators

1. **NAT Gateway Calculator**
   - Verify region prefix generation
   - Test filter combinations against Pricing API
   - Add integration test with real API calls

2. **ALB Calculator**
   - Fix LoadBalancer type detection (ALB vs NLB)
   - Verify pricing filters for eu-central-1
   - Add LCU cost calculation

3. **ECS Calculator**
   - Extract task definition properties from CloudFormation
   - Calculate Fargate pricing based on vCPU and memory
   - Handle both Fargate and EC2 launch types

4. **DynamoDB Calculator**
   - Implement pay-per-request pricing
   - Use usage assumptions from config
   - Add on-demand vs provisioned detection

### Phase 3: Add Missing Calculators

1. **AutoScaling Group Calculator**
   - Extract instance type from LaunchConfiguration/LaunchTemplate
   - Calculate cost based on min/max/desired capacity
   - Support multiple instance types in mixed instance policy

2. **LaunchTemplate Support**
   - Parse AWS::EC2::LaunchTemplate resources
   - Extract instance type and other pricing factors
   - Link to AutoScaling Groups

### Phase 4: Testing & Validation

1. **Integration Tests**
   - Test against real AWS Pricing API
   - Verify costs for all supported regions
   - Compare with AWS Pricing Calculator

2. **Test Fixtures**
   - Add CloudFormation templates for each resource type
   - Include edge cases (mixed instance types, spot instances)
   - Test with actual deployed stacks

3. **Documentation**
   - Document supported resource types
   - List known limitations
   - Provide troubleshooting guide

## Test Cases

### Test Case 1: NAT Gateway Pricing
```yaml
Input: CloudFormation template with AWS::EC2::NatGateway
Region: eu-central-1
Expected: ~$33/month (hourly rate + data processing)
Config: usageAssumptions.natGateway.dataProcessedGB = 500
```

### Test Case 2: Application Load Balancer
```yaml
Input: CloudFormation template with AWS::ElasticLoadBalancingV2::LoadBalancer (Type: application)
Region: eu-central-1
Expected: ~$16/month (hourly rate + LCU charges)
Config: usageAssumptions.alb.processedBytesGB = 1000
```

### Test Case 3: ECS Fargate Service
```yaml
Input: CloudFormation template with AWS::ECS::Service + TaskDefinition
Task: 0.25 vCPU, 0.5 GB memory
Desired Count: 2
Region: eu-central-1
Expected: ~$15-20/month
```

### Test Case 4: AutoScaling Group
```yaml
Input: CloudFormation template with AWS::AutoScaling::AutoScalingGroup
Instance Type: t3.micro
Desired Capacity: 2
Region: eu-central-1
Expected: ~$17.52/month (2 x $0.012/hour x 730 hours)
```

## Success Criteria

1. All calculators return non-zero costs for valid resources
2. Cost estimates within 10% of AWS Pricing Calculator
3. Debug mode shows pricing API queries and responses
4. Integration tests pass against real Pricing API
5. Documentation updated with supported resources

## Implementation Plan

1. **Week 1**: Add debug logging and improve error messages
2. **Week 2**: Fix NAT Gateway and ALB calculators
3. **Week 3**: Fix ECS and DynamoDB calculators
4. **Week 4**: Add AutoScaling Group calculator
5. **Week 5**: Integration tests and documentation

## GitHub Issues to Create

1. **Add debug logging for pricing API calls** (Phase 1)
2. **Fix NAT Gateway calculator pricing detection** (Phase 2)
3. **Fix ALB calculator pricing detection** (Phase 2)
4. **Fix ECS Fargate calculator pricing detection** (Phase 2)
5. **Fix DynamoDB calculator pricing detection** (Phase 2)
6. **Add AutoScaling Group calculator** (Phase 3)
7. **Add LaunchTemplate support for EC2 pricing** (Phase 3)
8. **Add integration tests for pricing calculators** (Phase 4)

## References

- AWS Pricing API: https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/price-changes.html
- Test stack: `demo/cdk.out/demo-dev.template.json`
- Pricing verification: Manual AWS Pricing API queries confirmed correct pricing data exists
